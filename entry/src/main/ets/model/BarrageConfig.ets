/**
 * å¼¹å¹•é…ç½®æ•°æ®æ¨¡å‹
 * ç”¨äºæ‰‹æŒå¼¹å¹•æ’­æŠ¥å™¨åº”ç”¨
 */

/**
 * è¾…åŠ©ç±»å‹å®šä¹‰
 */
export class LineStyle {
  fontSize: number = 48;
  fontColor: ResourceColor = '#FFFFFF';
  scale: number = 1;
}

export class RgbColor {
  r: number = 0;
  g: number = 0;
  b: number = 0;
}

/**
 * å¼¹å¹•ç‰‡æ®µ - ç”¨äºé«˜çº§æ¨¡å¼ä¸‹çš„å¯Œæ–‡æœ¬æ”¯æŒ
 */
@Observed
export class BarrageSegment {
  // å”¯ä¸€æ ‡è¯†
  id: string = '';

  // æ–‡æœ¬å†…å®¹
  text: string = '';

  // å­—ä½“å¤§å° (px)
  fontSize: number = 48;

  // å­—ä½“é¢œè‰²
  fontColor: ResourceColor = '#FFFFFF';

  // å­—ä½“ç²—ç»†
  fontWeight: FontWeight = FontWeight.Bold;

  // å­—ä½“æ ·å¼ (æ­£å¸¸/æ–œä½“)
  fontStyle: FontStyle = FontStyle.Normal;

  // å­—ä½“æ—
  fontFamily: string = 'HarmonyOS Sans';

  // æ–‡å­—è£…é¥° (ä¸‹åˆ’çº¿/åˆ é™¤çº¿ç­‰)
  decorationType: TextDecorationType = TextDecorationType.None;

  // æ˜¯å¦æœ‰é˜´å½±
  hasShadow: boolean = true;

  // æ˜¯å¦æ˜¯å›¾ç‰‡ç±»å‹
  isImage: boolean = false;

  // å›¾ç‰‡èµ„æº (å½“ isImage ä¸º true æ—¶ä½¿ç”¨)
  imageSource: string | Resource = '';

  // å›¾ç‰‡å®½åº¦
  imageWidth: number = 48;

  // å›¾ç‰‡é«˜åº¦
  imageHeight: number = 48;

  constructor(options?: Partial<BarrageSegment>) {
    if (options) {
      this.id = options.id ?? this.generateId();
      this.text = options.text ?? this.text;
      this.fontSize = options.fontSize ?? this.fontSize;
      this.fontColor = options.fontColor ?? this.fontColor;
      this.fontWeight = options.fontWeight ?? this.fontWeight;
      this.fontStyle = options.fontStyle ?? this.fontStyle;
      this.fontFamily = options.fontFamily ?? this.fontFamily;
      this.decorationType = options.decorationType ?? this.decorationType;
      this.hasShadow = options.hasShadow ?? this.hasShadow;
      this.isImage = options.isImage ?? this.isImage;
      this.imageSource = options.imageSource ?? this.imageSource;
      this.imageWidth = options.imageWidth ?? this.imageWidth;
      this.imageHeight = options.imageHeight ?? this.imageHeight;
    } else {
      this.id = this.generateId();
    }
  }

  private generateId(): string {
    return `segment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }

  // åˆ›å»ºæ–‡æœ¬ç‰‡æ®µ
  static createText(text: string, options?: Partial<BarrageSegment>): BarrageSegment {
    const segment = new BarrageSegment(options);
    segment.text = text;
    segment.isImage = false;
    return segment;
  }

  // åˆ›å»ºå›¾ç‰‡ç‰‡æ®µ
  static createImage(source: string | Resource, width: number = 48, height: number = 48): BarrageSegment {
    const segment = new BarrageSegment();
    segment.isImage = true;
    segment.imageSource = source;
    segment.imageWidth = width;
    segment.imageHeight = height;
    segment.text = '';
    return segment;
  }

  // å¤åˆ¶ç‰‡æ®µ
  clone(): BarrageSegment {
    const segment = new BarrageSegment();
    segment.id = this.generateId();
    segment.text = this.text;
    segment.fontSize = this.fontSize;
    segment.fontColor = this.fontColor;
    segment.fontWeight = this.fontWeight;
    segment.fontStyle = this.fontStyle;
    segment.fontFamily = this.fontFamily;
    segment.decorationType = this.decorationType;
    segment.hasShadow = this.hasShadow;
    segment.isImage = this.isImage;
    segment.imageSource = this.imageSource;
    segment.imageWidth = this.imageWidth;
    segment.imageHeight = this.imageHeight;
    return segment;
  }
}

/**
 * æ¸å˜è‰²åœæ­¢ç‚¹ç±»å‹
 */
export type GradientColorStop = [string, number]; // [é¢œè‰², ä½ç½®(0-1)]

/**
 * åŠ¨ç”»ç±»å‹æšä¸¾
 */
export type AnimationType = 'none' | 'scale' | 'rotate' | 'jump' | 'shake' | 'wave';

/**
 * æ»šåŠ¨æ–¹å‘æšä¸¾
 */
export type ScrollDirection = 'horizontal' | 'vertical';

/**
 * èƒŒæ™¯ç±»å‹æšä¸¾
 */
export type BackgroundType = 'color' | 'image' | 'video';

/**
 * LEDå½¢çŠ¶æšä¸¾
 */
export type LEDShape = 'circle' | 'square' | 'grid';

/**
 * ç²’å­ç±»å‹æšä¸¾ - å¢å¼ºç‰ˆ
 */
export type ParticleType = 'sparkle' | 'bubble' | 'fire' | 'snow' | 'star';

/**
 * é¢„è®¾æ¨¡æ¿ç±»å‹ - å¢å¼ºç‰ˆ
 */
export type PresetType = 'concert' | 'sports' | 'birthday' | 'neon' | 'christmas' | 'halloween' | 'romantic' | 'gaming' | 'custom';

/**
 * å¼¹å¹•ä¸»é…ç½®ç±»
 */
@Observed
export class BarrageConfig {
  // ===== åŸºç¡€å†…å®¹ =====

  // ç®€å•æ¨¡å¼æ–‡æœ¬å†…å®¹
  text: string = 'æ‰‹æŒå¼¹å¹• ğŸ‰';

  // æ˜¯å¦ä½¿ç”¨é«˜çº§æ¨¡å¼ (å¯Œæ–‡æœ¬)
  useAdvancedMode: boolean = false;

  // é«˜çº§æ¨¡å¼ç‰‡æ®µåˆ—è¡¨
  segments: BarrageSegment[] = [];

  // ===== å­—ä½“æ ·å¼ =====

  // å­—ä½“å¤§å° (px)
  fontSize: number = 64;

  // å­—ä½“é¢œè‰²
  fontColor: ResourceColor = '#FF0000';

  // å­—ä½“ç²—ç»†
  fontWeight: FontWeight = FontWeight.Bold;

  // å­—ä½“æ ·å¼
  fontStyle: FontStyle = FontStyle.Normal;

  // å­—ä½“æ—
  fontFamily: string = 'HarmonyOS Sans';

  // æ–‡å­—è£…é¥°ç±»å‹
  decorationType: TextDecorationType = TextDecorationType.None;

  // å­—é—´è· (px)
  letterSpacing: number = 2;

  // è¡Œé—´è· (px)
  lineSpacing: number = 10;

  // æ˜¯å¦æœ‰é˜´å½±
  hasShadow: boolean = true;

  // ===== æ¸å˜è‰²è®¾ç½® =====

  // æ˜¯å¦å¯ç”¨æ¸å˜è‰²
  gradientEnabled: boolean = false;

  // æ¸å˜è‰²æ•°ç»„
  gradientColors: GradientColorStop[] = [
    ['#FF0000', 0],
    ['#FFFF00', 0.5],
    ['#00FF00', 1]
  ];

  // æ¸å˜æ–¹å‘ (è§’åº¦)
  gradientDirection: number = 90;

  // ===== èƒŒæ™¯è®¾ç½® =====

  // èƒŒæ™¯ç±»å‹
  backgroundType: BackgroundType = 'color';

  // èƒŒæ™¯é¢œè‰²
  backgroundColor: ResourceColor = '#000000';

  // èƒŒæ™¯å›¾ç‰‡
  backgroundImage: string | Resource = '';

  // èƒŒæ™¯è§†é¢‘
  backgroundVideo: string | Resource = '';

  // èƒŒæ™¯é€æ˜åº¦ (0-1)
  backgroundOpacity: number = 1;

  // èƒŒæ™¯æ¨¡ç³Šç¨‹åº¦
  backgroundBlur: number = 0;

  // ===== æ»šåŠ¨è®¾ç½® =====

  // æ»šåŠ¨æ–¹å‘
  direction: ScrollDirection = 'horizontal';

  // æ»šåŠ¨é€Ÿåº¦ (1-100)
  scrollSpeed: number = 50;

  // ===== åŠ¨ç”»æ•ˆæœ =====

  // åŠ¨ç”»ç±»å‹
  animationType: AnimationType = 'none';

  // æ˜¯å¦å¯ç”¨é—ªçƒ
  isBlinking: boolean = false;

  // é—ªçƒé€Ÿåº¦ (1-100)
  blinkSpeed: number = 50;

  // ===== LEDæ•ˆæœ =====

  // æ˜¯å¦å¯ç”¨LEDæ•ˆæœ
  ledEnabled: boolean = false;

  // LEDå¯†åº¦ (åƒç´ å¤§å°)
  ledDensity: number = 4;

  // LEDå½¢çŠ¶
  ledShape: LEDShape = 'circle';

  // LEDé—´è·
  ledSpacing: number = 2;

  // ===== ç²’å­æ•ˆæœ =====

  // æ˜¯å¦å¯ç”¨ç²’å­æ•ˆæœ
  particleEnabled: boolean = false;

  // ç²’å­ç±»å‹
  particleType: ParticleType = 'sparkle';

  // ===== å±å¹•è®¾ç½® =====

  // å±å¹•æ–¹å‘é”å®š
  orientationLock: 'auto' | 'landscape' | 'portrait' = 'auto';

  // æ˜¯å¦ä¿æŒå±å¹•å¸¸äº®
  keepScreenOn: boolean = true;

  // ===== å¤šè¡Œå¼¹å¹•è®¾ç½® =====

  // æ˜¯å¦å¯ç”¨å¤šè¡Œæ¨¡å¼
  multiLineEnabled: boolean = false;

  // è¡Œæ•°
  lineCount: number = 1;

  // æ˜¯å¦æ‰€æœ‰è¡Œå†…å®¹ç›¸åŒ
  sameContent: boolean = true;

  // å¤šè¡Œå†…å®¹åˆ—è¡¨ (å½“ sameContent ä¸º false æ—¶ä½¿ç”¨)
  lineContents: string[] = [];

  // ç‰¹æ®Šè¡Œè®¾ç½®ç±»å‹
  specialLineType: 'none' | 'middle-large' | 'first-color' | 'gradient-size' | 'alternate-color' | 'rainbow' = 'none';

  // ç‰¹æ®Šè¡Œé¢œè‰²
  specialLineColor: ResourceColor = '#FFD700';

  // ä¸­é—´è¡Œæ”¾å¤§å€æ•°
  middleLineScale: number = 1.5;

  constructor(options?: Partial<BarrageConfig>) {
    if (options) {
      this.copyFromPartial(options);
    }
  }

  // ===== é¢„è®¾æ¨¡æ¿ =====

  /**
   * åŠ è½½é¢„è®¾æ¨¡æ¿
   */
  loadPreset(preset: PresetType): void {
    switch (preset) {
      case 'concert':
        this.applyConcertPreset();
        break;
      case 'sports':
        this.applySportsPreset();
        break;
      case 'birthday':
        this.applyBirthdayPreset();
        break;
      case 'neon':
        this.applyNeonPreset();
        break;
      case 'christmas':
        this.applyChristmasPreset();
        break;
      case 'halloween':
        this.applyHalloweenPreset();
        break;
      case 'romantic':
        this.applyRomanticPreset();
        break;
      case 'gaming':
        this.applyGamingPreset();
        break;
      default:
        // custom - ä¸åšä»»ä½•æ”¹å˜
        break;
    }
  }

  private applyConcertPreset(): void {
    this.text = 'æˆ‘çˆ±ä½ ï¼â¤ï¸ğŸ¤âœ¨';
    this.fontSize = 80;
    this.fontColor = '#FF1493';
    this.fontWeight = FontWeight.Bolder;
    this.backgroundColor = '#000000';
    this.hasShadow = true;
    this.gradientEnabled = true;
    const concertColors: GradientColorStop[] = [
      ['#FF1493', 0],
      ['#FF69B4', 0.5],
      ['#FFB6C1', 1]
    ];
    this.gradientColors = concertColors;
    this.isBlinking = true;
    this.blinkSpeed = 30;
    this.particleEnabled = true;
    this.particleType = 'sparkle';
  }

  private applySportsPreset(): void {
    this.text = 'åŠ æ²¹ï¼å†²å†²å†²ï¼ğŸ’ªğŸ”¥';
    this.fontSize = 72;
    this.fontColor = '#00FF00';
    this.fontWeight = FontWeight.Bolder;
    this.backgroundColor = '#1A1A2E';
    this.hasShadow = true;
    this.gradientEnabled = false;
    this.animationType = 'shake';
    this.isBlinking = false;
  }

  private applyBirthdayPreset(): void {
    this.text = 'ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‚ğŸ‰ğŸˆ';
    this.fontSize = 68;
    this.fontColor = '#FFD700';
    this.fontWeight = FontWeight.Bold;
    this.backgroundColor = '#FF69B4';
    this.gradientEnabled = true;
    const birthdayColors: GradientColorStop[] = [
      ['#FFD700', 0],
      ['#FFA500', 0.5],
      ['#FF6347', 1]
    ];
    this.gradientColors = birthdayColors;
    this.animationType = 'jump';
    this.particleEnabled = true;
    this.particleType = 'bubble';
  }

  private applyNeonPreset(): void {
    this.text = 'HELLO WORLD âš¡';
    this.fontSize = 76;
    this.fontColor = '#00FFFF';
    this.fontWeight = FontWeight.Bolder;
    this.backgroundColor = '#0A0A0A';
    this.hasShadow = true;
    this.gradientEnabled = true;
    const neonColors: GradientColorStop[] = [
      ['#00FFFF', 0],
      ['#FF00FF', 0.5],
      ['#00FFFF', 1]
    ];
    this.gradientColors = neonColors;
    this.ledEnabled = true;
    this.ledShape = 'circle';
    this.ledDensity = 3;
    this.ledSpacing = 1;
  }

  private applyChristmasPreset(): void {
    this.text = 'åœ£è¯å¿«ä¹ï¼ğŸ„ğŸ…â„ï¸';
    this.fontSize = 72;
    this.fontColor = '#FFFFFF';
    this.fontWeight = FontWeight.Bolder;
    this.backgroundColor = '#228B22';
    this.hasShadow = true;
    this.gradientEnabled = true;
    const christmasColors: GradientColorStop[] = [
      ['#FF0000', 0],
      ['#FFFFFF', 0.5],
      ['#00FF00', 1]
    ];
    this.gradientColors = christmasColors;
    this.particleEnabled = true;
    this.particleType = 'snow';
    this.animationType = 'wave';
  }

  private applyHalloweenPreset(): void {
    this.text = 'TRICK OR TREAT ğŸƒğŸ‘»ğŸ’€';
    this.fontSize = 68;
    this.fontColor = '#FF6600';
    this.fontWeight = FontWeight.Bolder;
    this.backgroundColor = '#1A0A2E';
    this.hasShadow = true;
    this.gradientEnabled = true;
    const halloweenColors: GradientColorStop[] = [
      ['#FF6600', 0],
      ['#8B00FF', 0.5],
      ['#FF6600', 1]
    ];
    this.gradientColors = halloweenColors;
    this.particleEnabled = true;
    this.particleType = 'fire';
    this.animationType = 'shake';
    this.isBlinking = true;
    this.blinkSpeed = 50;
  }

  private applyRomanticPreset(): void {
    this.text = 'I LOVE YOU â¤ï¸ğŸ’•ğŸ’–';
    this.fontSize = 80;
    this.fontColor = '#FF1493';
    this.fontWeight = FontWeight.Bolder;
    this.backgroundColor = '#2D0A2E';
    this.hasShadow = true;
    this.gradientEnabled = true;
    const romanticColors: GradientColorStop[] = [
      ['#FF69B4', 0],
      ['#FF1493', 0.3],
      ['#DC143C', 0.7],
      ['#FF69B4', 1]
    ];
    this.gradientColors = romanticColors;
    this.particleEnabled = true;
    this.particleType = 'star';
    this.animationType = 'scale';
  }

  private applyGamingPreset(): void {
    this.text = 'GG WP ğŸ®ğŸ†âš”ï¸';
    this.fontSize = 76;
    this.fontColor = '#00FF00';
    this.fontWeight = FontWeight.Bolder;
    this.backgroundColor = '#0D0D0D';
    this.hasShadow = true;
    this.gradientEnabled = true;
    const gamingColors: GradientColorStop[] = [
      ['#00FF00', 0],
      ['#00BFFF', 0.5],
      ['#FF00FF', 1]
    ];
    this.gradientColors = gamingColors;
    this.ledEnabled = true;
    this.ledShape = 'square';
    this.ledDensity = 4;
    this.ledSpacing = 1;
    this.animationType = 'jump';
  }

  // ===== å·¥å…·æ–¹æ³• =====

  /**
   * æ·»åŠ æ–‡æœ¬ç‰‡æ®µ (é«˜çº§æ¨¡å¼)
   */
  addTextSegment(text: string, options?: Partial<BarrageSegment>): void {
    this.segments.push(BarrageSegment.createText(text, options));
  }

  /**
   * æ·»åŠ å›¾ç‰‡ç‰‡æ®µ (é«˜çº§æ¨¡å¼)
   */
  addImageSegment(source: string | Resource, width?: number, height?: number): void {
    this.segments.push(BarrageSegment.createImage(source, width, height));
  }

  /**
   * åˆ é™¤ç‰‡æ®µ
   */
  removeSegment(index: number): void {
    if (index >= 0 && index < this.segments.length) {
      this.segments.splice(index, 1);
    }
  }

  /**
   * ç§»åŠ¨ç‰‡æ®µä½ç½®
   */
  moveSegment(fromIndex: number, toIndex: number): void {
    if (fromIndex >= 0 && fromIndex < this.segments.length &&
        toIndex >= 0 && toIndex < this.segments.length) {
      const removed = this.segments.splice(fromIndex, 1);
      const segment = removed[0];
      this.segments.splice(toIndex, 0, segment);
    }
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰ç‰‡æ®µ
   */
  clearSegments(): void {
    this.segments = [];
  }

  /**
   * è·å–ç”¨äºæ˜¾ç¤ºçš„æ–‡æœ¬è¡Œæ•°ç»„
   */
  getDisplayLines(): string[] {
    if (this.multiLineEnabled && !this.sameContent) {
      return this.lineContents.slice(0, this.lineCount);
    } else if (this.multiLineEnabled) {
      const result: string[] = [];
      for (let i = 0; i < this.lineCount; i++) {
        result.push(this.text);
      }
      return result;
    } else {
      return [this.text];
    }
  }

  /**
   * æ ¹æ®è¡Œç´¢å¼•è·å–è¡Œæ ·å¼
   */
  getLineStyle(lineIndex: number, totalLines: number): LineStyle {
    const result = new LineStyle();
    result.fontSize = this.fontSize;
    result.fontColor = this.fontColor;
    result.scale = 1;

    const middleIndex = Math.floor(totalLines / 2);

    switch (this.specialLineType) {
      case 'middle-large':
        if (lineIndex === middleIndex) {
          result.scale = this.middleLineScale;
        }
        break;

      case 'first-color':
        if (lineIndex === 0) {
          result.fontColor = this.specialLineColor;
        }
        break;

      case 'gradient-size':
        // ä¸­é—´å¤§ï¼Œä¸¤è¾¹å°
        const distanceFromMiddle = Math.abs(lineIndex - middleIndex);
        result.scale = 1 - (distanceFromMiddle / totalLines) * 0.4;
        break;

      case 'alternate-color':
        if (lineIndex % 2 === 1) {
          result.fontColor = this.specialLineColor;
        }
        break;

      case 'rainbow':
        const rainbowColors = ['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#4B0082', '#9400D3'];
        result.fontColor = rainbowColors[lineIndex % rainbowColors.length];
        break;
    }

    return result;
  }

  /**
   * å¯¼å‡ºé…ç½®ä¸ºJSON
   */
  toJSON(): string {
    return JSON.stringify({
      // åŸºç¡€å†…å®¹
      text: this.text,
      useAdvancedMode: this.useAdvancedMode,
      
      // å­—ä½“è®¾ç½®
      fontSize: this.fontSize,
      fontColor: this.fontColor,
      fontWeight: this.fontWeight,
      fontStyle: this.fontStyle,
      fontFamily: this.fontFamily,
      decorationType: this.decorationType,
      letterSpacing: this.letterSpacing,
      lineSpacing: this.lineSpacing,
      hasShadow: this.hasShadow,
      
      // æ¸å˜è®¾ç½®
      gradientEnabled: this.gradientEnabled,
      gradientColors: this.gradientColors,
      gradientDirection: this.gradientDirection,
      
      // èƒŒæ™¯è®¾ç½®
      backgroundType: this.backgroundType,
      backgroundColor: this.backgroundColor,
      backgroundImage: this.backgroundImage,
      backgroundVideo: this.backgroundVideo,
      backgroundOpacity: this.backgroundOpacity,
      backgroundBlur: this.backgroundBlur,
      
      // æ»šåŠ¨è®¾ç½®
      direction: this.direction,
      scrollSpeed: this.scrollSpeed,
      
      // åŠ¨ç”»è®¾ç½®
      animationType: this.animationType,
      isBlinking: this.isBlinking,
      blinkSpeed: this.blinkSpeed,
      
      // LED è®¾ç½®
      ledEnabled: this.ledEnabled,
      ledDensity: this.ledDensity,
      ledShape: this.ledShape,
      ledSpacing: this.ledSpacing,
      
      // ç²’å­è®¾ç½®
      particleEnabled: this.particleEnabled,
      particleType: this.particleType,
      
      // å¤šè¡Œè®¾ç½®
      multiLineEnabled: this.multiLineEnabled,
      lineCount: this.lineCount,
      sameContent: this.sameContent,
      lineContents: this.lineContents,
      specialLineType: this.specialLineType,
      specialLineColor: this.specialLineColor,
      middleLineScale: this.middleLineScale,
      
      // ç³»ç»Ÿè®¾ç½®
      orientationLock: this.orientationLock,
      keepScreenOn: this.keepScreenOn
    });
  }

  /**
   * ä»JSONå¯¼å…¥é…ç½®
   */
  static fromJSON(json: string): BarrageConfig {
    try {
      const data = JSON.parse(json) as Partial<BarrageConfig>;
      return new BarrageConfig(data);
    } catch (e) {
      const error = e as Error;
      console.error('Failed to parse BarrageConfig from JSON:', error.message);
      return new BarrageConfig();
    }
  }

  /**
   * é‡ç½®ä¸ºé»˜è®¤å€¼
   */
  reset(): void {
    const defaultConfig = new BarrageConfig();
    defaultConfig.copyTo(this);
  }

  /**
   * å¤åˆ¶é…ç½®
   */
  clone(): BarrageConfig {
    const cloned = new BarrageConfig();
    this.copyTo(cloned);
    return cloned;
  }

  /**
   * ä»å¦ä¸€ä¸ªé…ç½®å¤åˆ¶å±æ€§
   */
  copyFrom(source: BarrageConfig | Partial<BarrageConfig>): void {
    if (source instanceof BarrageConfig) {
      source.copyTo(this);
    } else {
      this.copyFromPartial(source);
    }
  }

  /**
   * ä»éƒ¨åˆ†é…ç½®å¤åˆ¶å±æ€§
   */
  private copyFromPartial(source: Partial<BarrageConfig>): void {
    if (source.text !== undefined) this.text = source.text;
    if (source.useAdvancedMode !== undefined) this.useAdvancedMode = source.useAdvancedMode;
    if (source.fontSize !== undefined) this.fontSize = source.fontSize;
    if (source.fontColor !== undefined) this.fontColor = source.fontColor;
    if (source.fontWeight !== undefined) this.fontWeight = source.fontWeight;
    if (source.fontStyle !== undefined) this.fontStyle = source.fontStyle;
    if (source.fontFamily !== undefined) this.fontFamily = source.fontFamily;
    if (source.decorationType !== undefined) this.decorationType = source.decorationType;
    if (source.letterSpacing !== undefined) this.letterSpacing = source.letterSpacing;
    if (source.lineSpacing !== undefined) this.lineSpacing = source.lineSpacing;
    if (source.hasShadow !== undefined) this.hasShadow = source.hasShadow;
    if (source.gradientEnabled !== undefined) this.gradientEnabled = source.gradientEnabled;
    if (source.gradientDirection !== undefined) this.gradientDirection = source.gradientDirection;
    if (source.backgroundType !== undefined) this.backgroundType = source.backgroundType;
    if (source.backgroundColor !== undefined) this.backgroundColor = source.backgroundColor;
    if (source.backgroundImage !== undefined) this.backgroundImage = source.backgroundImage;
    if (source.backgroundVideo !== undefined) this.backgroundVideo = source.backgroundVideo;
    if (source.backgroundOpacity !== undefined) this.backgroundOpacity = source.backgroundOpacity;
    if (source.backgroundBlur !== undefined) this.backgroundBlur = source.backgroundBlur;
    if (source.direction !== undefined) this.direction = source.direction;
    if (source.scrollSpeed !== undefined) this.scrollSpeed = source.scrollSpeed;
    if (source.animationType !== undefined) this.animationType = source.animationType;
    if (source.isBlinking !== undefined) this.isBlinking = source.isBlinking;
    if (source.blinkSpeed !== undefined) this.blinkSpeed = source.blinkSpeed;
    if (source.ledEnabled !== undefined) this.ledEnabled = source.ledEnabled;
    if (source.ledDensity !== undefined) this.ledDensity = source.ledDensity;
    if (source.ledShape !== undefined) this.ledShape = source.ledShape;
    if (source.ledSpacing !== undefined) this.ledSpacing = source.ledSpacing;
    if (source.particleEnabled !== undefined) this.particleEnabled = source.particleEnabled;
    if (source.particleType !== undefined) this.particleType = source.particleType;
    if (source.orientationLock !== undefined) this.orientationLock = source.orientationLock;
    if (source.keepScreenOn !== undefined) this.keepScreenOn = source.keepScreenOn;
    if (source.multiLineEnabled !== undefined) this.multiLineEnabled = source.multiLineEnabled;
    if (source.lineCount !== undefined) this.lineCount = source.lineCount;
    if (source.sameContent !== undefined) this.sameContent = source.sameContent;
    if (source.specialLineType !== undefined) this.specialLineType = source.specialLineType;
    if (source.specialLineColor !== undefined) this.specialLineColor = source.specialLineColor;
    if (source.middleLineScale !== undefined) this.middleLineScale = source.middleLineScale;

    // å¤„ç†æ•°ç»„
    if (source.gradientColors !== undefined) {
      this.gradientColors = source.gradientColors;
    }
    if (source.segments !== undefined) {
      this.segments = source.segments;
    }
    if (source.lineContents !== undefined) {
      this.lineContents = source.lineContents;
    }
  }

  /**
   * å°†å±æ€§å¤åˆ¶åˆ°ç›®æ ‡é…ç½®
   */
  private copyTo(target: BarrageConfig): void {
    target.text = this.text;
    target.useAdvancedMode = this.useAdvancedMode;
    target.fontSize = this.fontSize;
    target.fontColor = this.fontColor;
    target.fontWeight = this.fontWeight;
    target.fontStyle = this.fontStyle;
    target.fontFamily = this.fontFamily;
    target.decorationType = this.decorationType;
    target.letterSpacing = this.letterSpacing;
    target.lineSpacing = this.lineSpacing;
    target.hasShadow = this.hasShadow;
    target.gradientEnabled = this.gradientEnabled;
    target.gradientDirection = this.gradientDirection;
    target.backgroundType = this.backgroundType;
    target.backgroundColor = this.backgroundColor;
    target.backgroundImage = this.backgroundImage;
    target.backgroundVideo = this.backgroundVideo;
    target.backgroundOpacity = this.backgroundOpacity;
    target.backgroundBlur = this.backgroundBlur;
    target.direction = this.direction;
    target.scrollSpeed = this.scrollSpeed;
    target.animationType = this.animationType;
    target.isBlinking = this.isBlinking;
    target.blinkSpeed = this.blinkSpeed;
    target.ledEnabled = this.ledEnabled;
    target.ledDensity = this.ledDensity;
    target.ledShape = this.ledShape;
    target.ledSpacing = this.ledSpacing;
    target.particleEnabled = this.particleEnabled;
    target.particleType = this.particleType;
    target.orientationLock = this.orientationLock;
    target.keepScreenOn = this.keepScreenOn;
    target.multiLineEnabled = this.multiLineEnabled;
    target.lineCount = this.lineCount;
    target.sameContent = this.sameContent;
    target.specialLineType = this.specialLineType;
    target.specialLineColor = this.specialLineColor;
    target.middleLineScale = this.middleLineScale;
    
    // æ·±æ‹·è´æ•°ç»„
    target.segments = this.segments.map(s => s.clone());
    const gradientColorsCopy: GradientColorStop[] = [];
    for (let i = 0; i < this.gradientColors.length; i++) {
      const item = this.gradientColors[i];
      const copy: GradientColorStop = [item[0], item[1]];
      gradientColorsCopy.push(copy);
    }
    target.gradientColors = gradientColorsCopy;
    
    const lineContentsCopy: string[] = [];
    for (let i = 0; i < this.lineContents.length; i++) {
      lineContentsCopy.push(this.lineContents[i]);
    }
    target.lineContents = lineContentsCopy;
  }
}

/**
 * é¢œè‰²å·¥å…·ç±»
 */
export class ColorUtils {
  /**
   * å°† HSL è½¬æ¢ä¸º HEX
   */
  static hslToHex(h: number, s: number, l: number): string {
    s /= 100;
    l /= 100;

    const a = s * Math.min(l, 1 - l);
    const f = (n: number) => {
      const k = (n + h / 30) % 12;
      const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
      return Math.round(255 * color).toString(16).padStart(2, '0');
    };

    return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
  }

  /**
   * å°† HEX è½¬æ¢ä¸º RGB
   */
  static hexToRgb(hex: string): RgbColor | null {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    if (result) {
      const rgb = new RgbColor();
      rgb.r = parseInt(result[1], 16);
      rgb.g = parseInt(result[2], 16);
      rgb.b = parseInt(result[3], 16);
      return rgb;
    }
    return null;
  }

  /**
   * å°† RGB è½¬æ¢ä¸º HEX
   */
  static rgbToHex(r: number, g: number, b: number): string {
    return '#' + [r, g, b].map(x => {
      const hex = Math.max(0, Math.min(255, Math.round(x))).toString(16);
      return hex.length === 1 ? '0' + hex : hex;
    }).join('').toUpperCase();
  }

  /**
   * ç”Ÿæˆéšæœºé¢œè‰²
   */
  static randomColor(): string {
    return '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0').toUpperCase();
  }

  /**
   * è·å–å¯¹æ¯”è‰² (ç”¨äºç¡®ä¿æ–‡å­—å¯è¯»æ€§)
   */
  static getContrastColor(hexColor: string): string {
    const rgb = ColorUtils.hexToRgb(hexColor);
    if (!rgb) return '#FFFFFF';

    // è®¡ç®—äº®åº¦
    const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
    return luminance > 0.5 ? '#000000' : '#FFFFFF';
  }

  /**
   * è°ƒæ•´é¢œè‰²äº®åº¦
   */
  static adjustBrightness(hexColor: string, percent: number): string {
    const rgb = ColorUtils.hexToRgb(hexColor);
    if (!rgb) return hexColor;

    const adjustValue = (value: number): number => {
      const adjusted = value + (255 * percent / 100);
      return Math.min(255, Math.max(0, adjusted));
    };

    return ColorUtils.rgbToHex(adjustValue(rgb.r), adjustValue(rgb.g), adjustValue(rgb.b));
  }
}

/**
 * å¸¸ç”¨é¢„è®¾é¢œè‰²
 */
export class PresetColors {
  // åŸºç¡€è‰²
  static readonly red: string = '#FF0000';
  static readonly orange: string = '#FF7F00';
  static readonly yellow: string = '#FFFF00';
  static readonly green: string = '#00FF00';
  static readonly cyan: string = '#00FFFF';
  static readonly blue: string = '#0000FF';
  static readonly purple: string = '#8B00FF';
  static readonly pink: string = '#FF1493';
  static readonly white: string = '#FFFFFF';
  static readonly black: string = '#000000';

  // éœ“è™¹è‰²
  static readonly neonPink: string = '#FF6EC7';
  static readonly neonBlue: string = '#00D4FF';
  static readonly neonGreen: string = '#39FF14';
  static readonly neonYellow: string = '#FFFF33';
  static readonly neonOrange: string = '#FF6600';
  static readonly neonPurple: string = '#BF00FF';

  // é‡‘å±è‰²
  static readonly gold: string = '#FFD700';
  static readonly silver: string = '#C0C0C0';
  static readonly bronze: string = '#CD7F32';

  // åº”æ´è‰² (å¸¸è§å¶åƒå›¢ä½“åº”æ´è‰²)
  static readonly sakuraPink: string = '#FFB7C5';
  static readonly skyBlue: string = '#87CEEB';
  static readonly lemonYellow: string = '#FFF44F';
  static readonly mintGreen: string = '#98FF98';
  static readonly lavender: string = '#E6E6FA';
}

/**
 * å¸¸ç”¨æ¸å˜é¢„è®¾
 */
export class PresetGradients {
  static readonly sunset: GradientColorStop[] = [['#FF512F', 0], ['#DD2476', 1]];
  static readonly ocean: GradientColorStop[] = [['#2193B0', 0], ['#6DD5ED', 1]];
  static readonly forest: GradientColorStop[] = [['#134E5E', 0], ['#71B280', 1]];
  static readonly fire: GradientColorStop[] = [['#F12711', 0], ['#F5AF19', 1]];
  static readonly purple: GradientColorStop[] = [['#8E2DE2', 0], ['#4A00E0', 1]];
  static readonly rainbow: GradientColorStop[] = [['#FF0000', 0], ['#FF7F00', 0.17], ['#FFFF00', 0.33], ['#00FF00', 0.5], ['#0000FF', 0.67], ['#4B0082', 0.83], ['#9400D3', 1]];
  static readonly gold: GradientColorStop[] = [['#F7971E', 0], ['#FFD200', 1]];
  static readonly silver: GradientColorStop[] = [['#bdc3c7', 0], ['#2c3e50', 1]];
  static readonly neon: GradientColorStop[] = [['#00FFFF', 0], ['#FF00FF', 0.5], ['#00FFFF', 1]];
  static readonly candy: GradientColorStop[] = [['#FF61D2', 0], ['#FE9090', 0.5], ['#FFCC70', 1]];
}